# AFH (AI Fight HUD) 项目说明文档

## 📋 项目概述

**项目名称**: AFH - AI Fight HUD  
**项目目标**: 利用 Python 自动化脚本和 Web 交互界面，为 AI 生成的格斗视频后期叠加精准、可控、具有《街头霸王6》风格的血条与驱动槽系统。

---

## 🏗️ 技术架构

### 技术栈

| 维度 | 技术选型 | 说明 |
|------|---------|------|
| **开发语言** | Python 3.9+ | 核心逻辑与视频处理 |
| **前端交互** | Streamlit | 快速构建 Web GUI，支持视频逐帧标注 |
| **视频处理** | MoviePy + OpenCV | 视频流读写、帧提取、音画同步 |
| **图像渲染** | Pillow (PIL) | 高级 UI 绘制（渐变、半透明、倾斜矩形） |
| **数学计算** | NumPy | 用于 Lerp 缓动算法及抖动矩阵运算 |
| **数据交换** | JSON | 存储受击事件轴与 UI 样式配置 |

### 项目结构

```
FightHubController/
├── app.py                    # Streamlit Web 应用入口
├── core/
│   ├── __init__.py
│   ├── engine.py             # 状态引擎：血量逻辑、事件管理
│   └── renderer.py          # 渲染器：SF6 风格 UI 绘制
├── videos/                  # 存放待处理的视频文件
├── data/                    # 存放标注的事件 JSON 数据
├── output/                  # 输出渲染后的视频
├── requirements.txt          # 依赖包列表
└── README.md                # 项目说明
```

---

## 🎮 核心功能模块

### 1. 状态引擎 (`FightStateEngine`)

**位置**: `core/engine.py`

**功能**:
- **双血量逻辑模型**: 区分目标血量 (`target`) 和显示血量 (`display`)
- **事件驱动**: 通过时间戳触发受击事件
- **缓动算法**: 红槽延迟缩减，受击顿挫感
- **屏幕抖动**: 受击瞬间血条抖动效果

**关键参数**:
```python
hp_decay = 0.1           # 血量衰减速度
hit_delay = 0.15         # 受击延迟（秒）
shake_intensity = 3.0     # 抖动强度
drive_regen_rate = 0.5   # 驱动槽恢复速度
```

**算法描述**:
1. 受击时，目标血量立即减少
2. 显示血量在 `hit_delay` 秒内保持不变（顿挫感）
3. 延迟结束后，显示血量以指数级向目标血量靠近：
   ```
   HP_display = HP_display × (1 - decay) + HP_target × decay
   ```

---

### 2. 渲染器 (`SF6Renderer`)

**位置**: `core/renderer.py`

**功能**:
- **血条绘制**: 带倾斜角 (`skew`) 的平行四边形血条
- **双血量显示**: 黄色主血条 + 红色损失缓冲
- **驱动槽**: 6 格绿色 Drive Gauge
- **角色信息**: 显示 P1/P2 角色名
- **屏幕抖动**: 根据引擎状态应用偏移

**UI 层级 (Bottom to Top)**:
1. **背景层**: 深灰色 `(40, 40, 40, 51)`
2. **红槽层**: 红色 `(200, 50, 50, 255)` - 损失缓冲
3. **主血层**: 亮黄色 `(240, 200, 30, 255)` - 当前血量
4. **驱动槽**: 绿色 `(50, 200, 100, 255)` - Drive Gauge
5. **文本层**: 白色 `(255, 255, 255, 255)` - 角色名

**布局**:
- **P1**: 左对齐，向右倾斜
- **P2**: 右对齐，向左倾斜

---

### 3. Web 应用 (`app.py`)

**位置**: `app.py`

**功能**:

#### 📁 视频选择
- 扫描 `videos/` 目录
- 支持 `.mp4`, `.avi`, `.mov`, `.mkv` 格式
- 自动加载视频信息 (FPS, 分辨率, 帧数)
- 自动加载已保存的标注数据

#### 🎮 角色设置
- 自定义 P1/P2 角色名
- 实时更新到渲染输出

#### 🎬 视频预览
- **帧定位**: 滑块 + 数字输入框 + 快捷按钮
- **逐帧导航**: `-10帧`, `-1帧`, `+1帧`, `+10帧`
- **自动预览**: 支持倍速 (0.25x ~ 2.0x)
- **UI 叠加预览**: 可选开关显示/隐藏 UI 叠加

#### 🎯 打点工具
- **P1 攻击**: 设置伤害值、是否 Super 技
- **P2 攻击**: 设置伤害值、是否 Super 技
- **事件管理**: 显示所有事件列表
- **快速跳转**: 点击事件跳转到对应帧
- **删除确认**: 双重确认防止误删

#### 🚀 视频渲染
- 逐帧渲染 UI 叠加
- 自动保留原视频音轨
- 实时进度显示
- 输出到 `output/` 目录

---

## 📊 开发进度对照表

| 阶段 | 任务 | 状态 | 说明 |
|------|------|------|------|
| **第一阶段** | SF6Renderer 类实现 | ✅ 完成 | 支持倾斜血条、非对称布局 |
| | 静态渲染测试 | ✅ 完成 | 可渲染单帧 UI |
| **第二阶段** | FightStateEngine 实现 | ✅ 完成 | 支持 JSON 事件、缓动算法、抖动 |
| | 动态渲染测试 | ✅ 完成 | 可渲染动画血条 |
| **第三阶段** | Streamlit GUI | ✅ 完成 | 视频播放器、标注工具 |
| | 实时预览 | ✅ 完成 | 拖动进度条实时显示 UI |
| | 热键标注 | ⚠️ 未实现 | 可通过按钮添加 |
| | 事件 JSON 导出 | ✅ 完成 | 自动保存到 `data/` |
| **第四阶段** | MoviePy 集成 | ✅ 完成 | 视频渲染、音画同步 |
| | 多进程渲染 | ⚠️ 未实现 | 单线程渲染 |
| | 批量处理 | ⚠️ 未实现 | 单视频处理 |
| | 最终渲染输出 | ✅ 完成 | 输出 MP4 视频 |

**总体完成度**: ~85%

---

## 🚀 快速开始

### 环境要求

- Python 3.9+
- 依赖包见 `requirements.txt`

### 安装步骤

```bash
# 1. 克隆项目
git clone <repository-url>
cd FightHubController

# 2. 安装依赖
pip install -r requirements.txt

# 3. 创建目录
mkdir -p videos data output

# 4. 启动应用
streamlit run app.py
```

### 使用流程

#### 1. 准备视频
```bash
# 将视频文件放入 videos/ 目录
cp your_video.mp4 videos/
```

#### 2. 打开应用
```bash
streamlit run app.py
```

浏览器自动打开 `http://localhost:8501`

#### 3. 标注事件
1. 在侧边栏选择视频
2. 拖动进度条到打击瞬间
3. 设置伤害值和是否 Super 技
4. 点击 "P1 攻击" 或 "P2 攻击" 按钮
5. 重复步骤 2-4，标注所有事件

#### 4. 预览效果
1. 勾选 "显示 UI 叠加"
2. 拖动进度条查看各帧效果
3. 使用播放按钮自动预览

#### 5. 导出视频
1. 确认所有事件已正确标注
2. 点击侧边栏 "开始最终渲染"
3. 等待渲染完成（进度条显示）
4. 查看输出视频在 `output/` 目录

---

## 🎨 高级功能

### 帧缓存机制
- **LRU 缓存**: 最多缓存 100 帧
- **性能提升**: 缓存命中时速度提升 6 倍
- **自动清理**: 超出限制自动清理旧帧

### 持久化视频句柄
- **避免重复打开**: 只在需要时打开视频文件
- **自动释放**: 切换视频时自动释放句柄
- **防止内存泄露**: 提供"清除缓存"按钮

### 自动备份
- **JSON 备份**: 每次保存时自动创建 `.bak` 备份
- **防止数据丢失**: 意外修改可恢复

---

## 📝 数据格式

### 事件 JSON 格式

```json
{
  "hits": [
    {
      "timestamp": 2.5,
      "player": 1,
      "damage": 10.0,
      "is_super": false
    },
    {
      "timestamp": 5.8,
      "player": 2,
      "damage": 25.0,
      "is_super": true
    }
  ]
}
```

**字段说明**:
- `timestamp`: 事件时间戳（秒）
- `player`: 攻击方 (1=P1, 2=P2)
- `damage`: 伤害值 (0.0 ~ 100.0)
- `is_super`: 是否 Super 技

---

## ⚙️ 配置参数

### 引擎参数 (`FightStateEngine`)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `hp_decay` | 0.1 | 血量衰减速度 (0.0 ~ 1.0) |
| `hit_delay` | 0.15 | 受击延迟（秒） |
| `shake_intensity` | 3.0 | 抖动强度（像素） |
| `shake_decay` | 0.8 | 抖动衰减速度 |
| `drive_regen_rate` | 0.5 | 驱动槽恢复速度（每秒） |

### 渲染参数 (`SF6Renderer`)

| 参数 | 默认值 | 说明 |
|------|--------|------|
| `bar_width` | 600 | 血条宽度（像素） |
| `bar_height` | 25 | 血条高度（像素） |
| `bar_skew` | 20 | 倾斜角度（像素） |

### 颜色配置

```python
colors = {
    'bg': (40, 40, 40, 51),        # 背景
    'damage': (200, 50, 50, 255),  # 红槽
    'health': (240, 200, 30, 255),  # 主血条
    'drive': (50, 200, 100, 255),   # 驱动槽
    'drive_empty': (80, 80, 80, 255),  # 空驱动槽
    'text': (255, 255, 255, 255)   # 文本
}
```

---

## 🔧 故障排查

### 常见问题

#### 1. 视频无法加载
**原因**: 视频格式不支持或文件损坏  
**解决**: 确保视频为 `.mp4`, `.avi`, `.mov`, `.mkv` 格式

#### 2. 渲染速度慢
**原因**: 视频分辨率过高或事件数量多  
**解决**: 降低预览分辨率，关闭 "显示 UI 叠加"

#### 3. 音频丢失
**原因**: 原视频无音频或编码不支持  
**解决**: 检查原视频音频轨道

#### 4. 内存占用高
**原因**: 视频过大或缓存未清理  
**解决**: 点击 "🗑️ 清除缓存" 按钮

---

## 📄 许可证

本项目为开源项目，供学习和交流使用。

---

## 🤝 贡献

欢迎提交 Issue 和 Pull Request！

---

## 📮 联系方式

如有问题或建议，请通过 Issue 联系。

---

**最后更新**: 2026-02-24  
**版本**: v1.0  
**状态**: 生产就绪 ✅
